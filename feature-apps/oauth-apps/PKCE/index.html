<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OAuth 2.0 with PKCE</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f4f4f4;
                margin: 0;
                padding: 20px;
            }
            h1 {
                text-align: center;
                color: #333;
            }
            h2 {
                color: #555;
                margin-top: 20px;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
            }

            button:hover {
                background-color: #0056b3;
            }
            input[type="text"] {
                width: calc(100% - 22px);
                padding: 10px;
                margin: 10px 0;
                border: 1px solid #ccc;
                border-radius: 5px;
                font-size: 16px;
            }
            input[type="text"]:focus {
                border-color: #007bff;
                outline: none;
            }
            #contactsList {
                list-style-type: none;
                padding: 0;
            }
            #contactsList li {
                background-color: white;
                margin: 5px 0;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
            .container {
                max-width: 600px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Klaviyo with PKCE</h1>
            <button id="authorize-btn">Authorize</button>

            <h2>Add Contact</h2>
            <input type="text" id="email" placeholder="Enter Email" required>
            <input type="text" id="firstName" placeholder="First Name (optional)">
            <input type="text" id="lastName" placeholder="Last Name (optional)">
            <button onclick="addContact()">Add Contact</button>

            <h2>Contacts</h2>
            <button id="fetchContactsBtn">Fetch Contacts</button>
            <ul id="contactsList"></ul>
        </div>

        <script>
            async function generateRandomString(length) {
                const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                return result;
            }

            async function generateCodeChallenge(codeVerifier) {
                const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
                return btoa(String.fromCharCode(...new Uint8Array(hash)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }

            async function redirectToAuthorization() {
                const clientId = 'ca45edad-a387-42eb-8cae-21a5efdc6cc2';
                const redirectUri = 'http://localhost:3000/callback';
                const scope = 'accounts:read events:read events:write profiles:read profiles:write';
                const state = await generateRandomString(32);
                const codeVerifier = await generateRandomString(64);
                const codeChallenge = await generateCodeChallenge(codeVerifier);

                localStorage.setItem('code_verifier', codeVerifier);

                const authorizationUrl = `https://klaviyo.com/oauth/authorize?` +
                    `response_type=code&` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `scope=${scope}&` +
                    `state=${state}&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256`;

                console.log('Redirecting to:', authorizationUrl);
                window.location.href = authorizationUrl;
            }

            function addContact() {
                const email = document.getElementById('email').value;
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const accessToken = localStorage.getItem('access_token');

                if (!accessToken) {
                    alert("Access Token is missing!");
                    return;
                }

                fetch('/add-contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken, email, firstName, lastName })
                })
                    .then(res => res.json())
                    .then(data => alert("Contact Added Successfully!"))
                    .catch(err => alert("Error Adding Contact!"));
            }

            document.getElementById('fetchContactsBtn').addEventListener('click', async function () {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    alert("Access Token is missing!");
                    return;
                }

                try {
                    const response = await fetch(`/contacts?accessToken=${accessToken}`);
                    const data = await response.json();

                    console.log("Contacts:", data);

                    // Clear previous list
                    const contactsList = document.getElementById('contactsList');
                    contactsList.innerHTML = "";

                    if (data.data && data.data.length > 0) {
                        data.data.forEach(contact => {
                            const listItem = document.createElement('li');
                            listItem.textContent = `${contact.attributes.email} - ${contact.attributes.first_name || ''} ${contact.attributes.last_name || ''}`;
                            contactsList.appendChild(listItem);
                        });
                    } else {
                        contactsList.innerHTML = "<li>No contacts found.</li>";
                    }

                } catch (error) {
                    console.error("Error fetching contacts:", error);
                    alert("Failed to fetch contacts.");
                }
            });
            document.getElementById('authorize-btn').addEventListener('click', redirectToAuthorization);
        </script>
    </body>
</html>